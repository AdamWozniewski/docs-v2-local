import { Prerequisites } from "/snippets/get-started/prerequisites/user-authentication.jsx";

<Prerequisites
  callbackUrl="http://localhost:8000/api/auth/callback"
  logoutUrl="http://localhost:5173"
/>

### Create a FastAPI application

Run the following commands to clone this starter template from the [Auth0 AI samples](https://github.com/auth0-samples/auth0-ai-samples) repository:

```bash wrap lines
git clone https://github.com/auth0-samples/auth0-ai-samples.git
cd auth0-ai-samples/authenticate-users/langchain-fastapi-py-starter
```

The project is divided into two parts across these folders:

- `backend`: contains the backend code for the Web application and API written in Python using FastAPI and the LangGraph agent.
- `frontend`: contains the frontend code for the Web application written in React as a Vite Single Page App (SPA).

### Install dependencies

In the `backend` directory of your project, install the [Auth0 FastAPI SDK](https://github.com/auth0/auth0-fastapi) for implementing user authentication in FastAPI applications.

Ensure you have `uv` installed or follow the instructions here to [install uv](https://docs.astral.sh/uv/getting-started/installation/).
Run the following command to install the required dependencies:

```bash wrap lines
cd backend
uv sync
uv add auth0-fastapi
```

### Add authentication to your application backend

Secure the application using the Auth0 FastAPI SDK.

#### Create your environment file

In the `backend` directory of your project, create a new file and name it `.env` and add the following contnet:

```bash .env wrap lines
APP_BASE_URL='http://localhost:3000'
AUTH0_SECRET='random 32 byte value'
AUTH0_DOMAIN='<your-auth0-domain>'
AUTH0_CLIENT_ID='<your-auth0-application-client-id>'
AUTH0_CLIENT_SECRET='<your-auth0-application-client-secret>'
```
Access your `AUTH0_DOMAIN`, `AUTH0_CLIENT_ID`, and `AUTH0_CLIENT_SECRET` by viewing the Auth0 Application that you created in the Auth0 Dashboard and navigating to the Basic Information section at the top of the Settings tab.
Copy each value to the matching setting.

Next, run this command to generate a random 32 byte value and copy it to the <code>AUTH0_SECRET</code> field.
```bash generate random 32 byte value
openssl rand -hex 32
```

#### Update the application configuration

Update the configuration settings in `app/core/config.py`:

```python app/core/config.py wrap lines highlight={4-8}
# ...
class Settings(BaseSettings):
    # ...
    AUTH0_DOMAIN: str
    AUTH0_CLIENT_ID: str
    AUTH0_CLIENT_SECRET: str
    AUTH0_SECRET: str
    APP_BASE_URL: str
# ...
```

#### Create the Auth0 client

Create a file in the `app/core` directory and name it `auth.py`. Add the following code to create a new Auth0 client:

```python app/core/auth.py wrap lines
from auth0_fastapi.auth import AuthClient
from auth0_fastapi.config import Auth0Config
from auth0_fastapi.server.routes import router as auth_router, register_auth_routes

from app.core.config import settings

auth_config = Auth0Config(
    domain=settings.AUTH0_DOMAIN,
    client_id=settings.AUTH0_CLIENT_ID,
    client_secret=settings.AUTH0_CLIENT_SECRET,
    secret=settings.AUTH0_SECRET,
    app_base_url=f"{settings.APP_BASE_URL}{settings.API_PREFIX}",
    mount_routes=True,
    mount_connect_routes=True,
    authorization_params={
        "scope": "openid profile email offline_access",
    },
)

auth_client = AuthClient(auth_config)

register_auth_routes(auth_router, auth_config)
```

The Auth0 client provides methods for handling authentication, sessions, and user data.

#### Add the authentication middleware

Update the `app/main.py` file to include the authentication middleware:

```python app/main.py wrap lines highlight={2,4,8,11}
# ...
from starlette.middleware.sessions import SessionMiddleware

from app.core.auth import auth_client
# ...

# Set the session middleware
app.add_middleware(SessionMiddleware, secret_key=settings.AUTH0_SECRET)

# Save auth state
app.state.auth_client = auth_client
# ...
```

#### Add the authentication routes

Update the `app/api/api_router.py` file to include the authentication routes:

```python app/api/api_router.py wrap lines highlight={2,5}
# ...
from app.core.auth import auth_router
# ...

api_router.include_router(auth_router, tags=["auth"])
```

### Add authentication to your application frontend

Add log in and sign up buttons to your application frontend.

Ensure you have `npm` installed or follow the instructions here to [install npm](https://docs.npmjs.com/downloading-and-installing-node-js-and-npm).
Navigate to the `frontend` directory of your project and install the required dependencies:

```bash wrap lines
cd frontend
npm install
```

#### Add an authentication utilities file

In the `src/lib` directory create a new file and name it `use-auth.ts`. Add the following code to the file:

```tsx src/lib/use-auth.ts wrap lines
import { useQuery } from "@tanstack/react-query";
import { apiClient } from "./api-client";

export default function useAuth() {
  const { data: user, isLoading } = useQuery({
    queryKey: ["user"],
    queryFn: async () => {
      return (await apiClient.get("/api/auth/profile")).data?.user;
    },
  });

  return {
    user,
    isLoading,
  };
}

export function getLoginUrl() {
  return `${import.meta.env.VITE_API_HOST}/api/auth/login?returnTo=${
    window.location
  }`;
}

export function getSignupUrl() {
  return `${import.meta.env.VITE_API_HOST}/api/auth/login?screen_hint=signup`;
}

export function getLogoutUrl() {
  return `${import.meta.env.VITE_API_HOST}/api/auth/logout?returnTo=${
    window.location
  }`;
}
```

#### Add Log in and Sign up buttons

Update the `src/pages/ChatPage.tsx` file with the following code to check if the user is signed in or not.
It will display the **Sign up** or **Log in** buttons without a user session. If a user session exists, the app displays a welcome message with the user's name.

```tsx src/pages/ChatPage.tsx wrap lines highlight={2-4,7,9-11,13-33,42}
//...
import useAuth, { getLoginUrl, getSignupUrl } from "@/lib/use-auth";
import { Button } from "@/components/ui/button";
import { LogIn, UserPlus } from "lucide-react";

export default function ChatPage() {
  const { user, isLoading } = useAuth();

  if (isLoading) {
    return <div>Loading...</div>;
  }

  if (!user) {
    return (
      <div className="flex flex-col items-center justify-center min-h-[50vh] my-auto gap-4">
        <h2 className="text-xl">You are not logged in</h2>
        <div className="flex gap-4">
          <Button asChild variant="default" size="default">
            <a href={getLoginUrl()} className="flex items-center gap-2">
              <LogIn />
              <span>Login</span>
            </a>
          </Button>
          <Button asChild variant="default" size="default">
            <a href={getSignupUrl()} className="flex items-center gap-2">
              <UserPlus />
              <span>Sign up</span>
            </a>
          </Button>
        </div>
      </div>
    );
  }

  //... existing code

  // applicable only if you are using the starter template
  return (
    <ChatWindow
      endpoint="/api/agent"
      emoji="ðŸ¤–"
      placeholder={`Hello ${user?.name}, I'm your personal assistant. How can I help you today?`}
      emptyStateComponent={InfoCard}
    />
  );
}
```

### Add User Profile Dropdown (Optional)

If you are using the starter template, you can add a user profile dropdown to your application. Update the `src/components/layout.tsx` file:

```tsx src/components/layout.tsx wrap lines highlight={2,3,6,13-17}
//...
import useAuth, { getLogoutUrl } from "@/lib/use-auth";
import UserButton from "@/components/auth0/user-button";

export default function Layout() {
  const { user } = useAuth();

  return (
    <div className="bg-secondary grid grid-rows-[auto_1fr] h-[100dvh]">
      <div className="grid grid-cols-[1fr_auto] gap-2 p-4 bg-black/25">
        {/* ... existing code */}
        <div className="flex justify-center">
          {user && (
            <div className="flex items-center gap-2 px-4 text-white">
              <UserButton user={user} logoutUrl={getLogoutUrl()} />
            </div>
          )}
          {/* ... existing code */}
        </div>
      </div>
    </div>
  );
}
```

### Run your application

To run your application, start both the FastAPI backend and the frontend in two terminals:

1. In the terminal, start the FastAPI backend:

```bash wrap lines
cd backend
source .venv/bin/activate
fastapi dev app/main.py
```

2. In a new terminal, start the frontend:

```bash wrap lines
cd frontend
cp .env.example .env # Copy the `.env.example` file to `.env`.
npm run dev
```

Visit the URL `http://localhost:5173` in your browser.

You will see:

<Frame>
  ![Auth0 login
  screen](/img/user_authentication_quickstart_login_screen.png)
</Frame>

Sign up to your application to create a new user account. You will then see a welcome message with your user name. You can sign in with that account on future visits.
